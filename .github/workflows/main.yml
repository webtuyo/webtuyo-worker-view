name: Deploy Cloudflare Worker 

on:
  workflow_dispatch:
    inputs:
      worker_name:
        description: 'Worker Name'
        required: true
        type: string
      domain:
        description: 'Your Domain'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22' 
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Specific Wrangler Version
        # Installing globally can sometimes cause issues; consider npx or local install
        # Using npx wrangler@<version> in each command is often safer
        run: npm install -g wrangler@4.14.1 # Pinning the version is good

      - name: Check Wrangler Version
        run: wrangler --version

      # --- STEP 1: Substitute STATIC names first ---
      # This ensures wrangler create commands use the correct names if needed
      # Although wrangler create uses args here, it's good practice if other
      # commands read the file before IDs are known.
      - name: Substitute static names in wrangler.toml
        run: |
          echo "Substituting static names in wrangler.toml..."
          # Use a different delimiter for sed in case names have slashes
          sed -i "s|\${WORKER_NAME}|${{ github.event.inputs.worker_name }}|g" wrangler.toml
          sed -i "s|\${DB_NAME}|${{ github.event.inputs.worker_name }}-DB|g" wrangler.toml
          sed -i "s|\${YOUR_DOMAIN}|${{ github.event.inputs.domain }}|g" wrangler.toml
          echo "wrangler.toml after static substitution:"
          cat wrangler.toml

      # --- STEP 2: Deploy Worker ---
      # wrangler.toml is now fully substituted, deploy should work
      - name: Deploy Worker
        # Use npx wrangler
        run: npx wrangler@4.14.1 deploy
        env:
          # Provide credentials for the deploy command itself
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
